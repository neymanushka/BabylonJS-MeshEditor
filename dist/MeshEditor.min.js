var org;!function(t){!function(e){!function(e){!function(e){var i=BABYLON.Color3,o=BABYLON.Vector3,s=BABYLON.Mesh,r=BABYLON.StandardMaterial,n=BABYLON.Path2,a=BABYLON.VertexBuffer,h=t.ssatguru.babylonjs.component.EditControl,p=function(){function t(t,e,i,r){var n=this;this.facePicked=0,this.ec=null,this.mode="F",this.v1v=new o(0,0,0),this.v2v=new o(0,0,0),this.v3v=new o(0,0,0),this.pTemp=o.Zero(),this.mesh=t,this.camera=e,this.canvas=i,this.scene=r,this.mesh.markVerticesDataAsUpdatable(a.PositionKind,!0),this.vertices=t.getVerticesData(a.PositionKind),this.faceVertices=t.getIndices(),this.faceSelector=this.createFaceSelector(r),this.edgeSelector=this.createEdgeSelector(r),this.pointSelector=new s("pointSelector",r),this.ec=null,r.pointerDownPredicate=function(t){return t==n.mesh},r.onPointerDown=function(t,e){if(2==t.button&&e.hit){if(console.log(e.pickedMesh),e.pickedMesh!=n.mesh)return;n.facePicked=e.faceId;var i=null;"F"==n.mode?(i=n.faceSelector,n.highLightFace(n.facePicked,i)):"E"==n.mode?(i=n.edgeSelector,n.highLightEdge(n.facePicked,e.pickedPoint,i)):"P"==n.mode&&(i=n.pointSelector,n.highLightPoint(n.facePicked,e.pickedPoint,i)),null!=i&&(i.visibility=1,null==n.ec?n.ec=n.createEditControl(i,n.camera,n.canvas):(n.ec.isHidden()&&n.ec.show(),n.ec.switchTo(i,!0)))}}}return t.prototype.enablePoint=function(){"P"!=this.mode&&(this.mode="P",this.faceSelector.visibility=0,this.edgeSelector.visibility=0,this.ec.hide())},t.prototype.enableEdge=function(){"E"!=this.mode&&(this.mode="E",this.faceSelector.visibility=0,this.pointSelector.visibility=0,this.ec.hide())},t.prototype.enableFace=function(){"F"!=this.mode&&(this.mode="F",this.edgeSelector.visibility=0,this.pointSelector.visibility=0,this.ec.hide())},t.prototype.createEditControl=function(t,e,i){var o=this,s=new h(t,e,i,.5,!0);return s.setLocal(!0),s.enableTranslation(),s.addActionListener(function(t){"F"==o.mode?o.updateFacePosition(o.facePicked,o.faceSelector):"E"==o.mode?o.updateEdgePosition(o.facePicked,o.edgeSelector):"P"==o.mode&&o.updatePointPosition(o.facePicked,o.pointSelector),o.mesh.updateVerticesData(a.PositionKind,o.vertices,!1,!1)}),s},t.prototype.createFaceSelector_old=function(t){var e=this.createTriangle("selector",1,t);return e.material=new r("impactMat",t),e.material.diffuseColor=i.Gray(),e.visibility=.8,e.markVerticesDataAsUpdatable(a.PositionKind,!0),e.renderingGroupId=1,e},t.prototype.createFaceSelector=function(t){var e=s.CreateLines("edgeSelector",[new o(-1,0,0),new o(1,0,0),new o(0,0,1),new o(-1,0,0)],t);return e.color=i.Black(),e.visibility=0,e.markVerticesDataAsUpdatable(a.PositionKind,!0),e.renderingGroupId=1,e},t.prototype.createEdgeSelector=function(t){var e=s.CreateLines("edgeSelector",[new o(-1,0,0),new o(1,0,0)],t);return e.color=i.Black(),e.isPickable=!1,e.renderingGroupId=1,e.visibility=0,e.markVerticesDataAsUpdatable(a.PositionKind,!0),e},t.prototype.highLightFace=function(t,e){console.log("highLightFace"),this.getFaceVertices(t,this.mesh,this.faceVertices);var i=this.v1v.subtract(this.v2v),s=this.v3v.subtract(this.v2v);e.rotation=this.getRotation(i,s),e.position.x=(this.v1v.x+this.v2v.x+this.v3v.x)/3,e.position.y=(this.v1v.y+this.v2v.y+this.v3v.y)/3,e.position.z=(this.v1v.z+this.v2v.z+this.v3v.z)/3;var r=e.getVerticesData(a.PositionKind);console.log(r.length);var n=e.getWorldMatrix().clone().invert();o.TransformCoordinatesToRef(this.v1v,n,this.pTemp),r[0]=this.pTemp.x,r[1]=this.pTemp.y,r[2]=this.pTemp.z,o.TransformCoordinatesToRef(this.v2v,n,this.pTemp),r[3]=this.pTemp.x,r[4]=this.pTemp.y,r[5]=this.pTemp.z,o.TransformCoordinatesToRef(this.v3v,n,this.pTemp),r[6]=this.pTemp.x,r[7]=this.pTemp.y,r[8]=this.pTemp.z,r[9]=r[0],r[10]=r[1],r[11]=r[2],e.setVerticesData(a.PositionKind,r,!0)},t.prototype.updateFacePosition=function(t,e){var i=3*t,s=this.faceVertices[i],r=this.faceVertices[i+1],n=this.faceVertices[i+2],h=this.vertices,p=3*s,c=3*r,l=3*n,v=e.getVerticesData(a.PositionKind),m=e.getWorldMatrix(),d=this.mesh.getWorldMatrix().clone().invert();o.TransformCoordinatesFromFloatsToRef(v[0],v[1],v[2],m,this.pTemp),o.TransformCoordinatesFromFloatsToRef(this.pTemp.x,this.pTemp.y,this.pTemp.z,d,this.pTemp),h[p]=this.pTemp.x,h[p+1]=this.pTemp.y,h[p+2]=this.pTemp.z,o.TransformCoordinatesFromFloatsToRef(v[3],v[4],v[5],m,this.pTemp),o.TransformCoordinatesFromFloatsToRef(this.pTemp.x,this.pTemp.y,this.pTemp.z,d,this.pTemp),h[c]=this.pTemp.x,h[c+1]=this.pTemp.y,h[c+2]=this.pTemp.z,o.TransformCoordinatesFromFloatsToRef(v[6],v[7],v[8],m,this.pTemp),o.TransformCoordinatesFromFloatsToRef(this.pTemp.x,this.pTemp.y,this.pTemp.z,d,this.pTemp),h[l]=this.pTemp.x,h[l+1]=this.pTemp.y,h[l+2]=this.pTemp.z},t.prototype.highLightEdge=function(t,e,i){console.log("highLightEdge"),this.getFaceVertices(t,this.mesh,this.faceVertices);var s,r,n,h=this.getDistance(e,this.v1v,this.v2v),p=this.getDistance(e,this.v2v,this.v3v),c=this.getDistance(e,this.v3v,this.v1v),l=Math.min(h,p,c);l==h&&(s=this.v1v,r=this.v2v,n=this.v3v,this.ep1=1,this.ep2=2),l==p&&(s=this.v2v,r=this.v3v,n=this.v1v,this.ep1=2,this.ep2=3),l==c&&(s=this.v3v,r=this.v1v,n=this.v2v,this.ep1=3,this.ep2=1);var v=s.subtract(r),m=n.subtract(r);i.rotation=this.getRotation(v,m),i.position.x=(s.x+r.x)/2,i.position.y=(s.y+r.y)/2,i.position.z=(s.z+r.z)/2;var d=i.getVerticesData(a.PositionKind),T=i.getWorldMatrix().clone().invert();o.TransformCoordinatesToRef(s,T,this.pTemp),d[0]=this.pTemp.x,d[1]=this.pTemp.y,d[2]=this.pTemp.z,o.TransformCoordinatesToRef(r,T,this.pTemp),d[3]=this.pTemp.x,d[4]=this.pTemp.y,d[5]=this.pTemp.z,i.setVerticesData(a.PositionKind,d,!0),this.ec.switchTo(i,!0)},t.prototype.updateEdgePosition=function(t,e){var i=3*t,s=this.faceVertices[i+this.ep1-1],r=this.faceVertices[i+this.ep2-1],n=this.vertices,h=3*s,p=3*r,c=e.getVerticesData(a.PositionKind),l=e.getWorldMatrix(),v=this.mesh.getWorldMatrix().clone().invert();o.TransformCoordinatesFromFloatsToRef(c[0],c[1],c[2],l,this.pTemp),o.TransformCoordinatesFromFloatsToRef(this.pTemp.x,this.pTemp.y,this.pTemp.z,v,this.pTemp),n[h]=this.pTemp.x,n[h+1]=this.pTemp.y,n[h+2]=this.pTemp.z,o.TransformCoordinatesFromFloatsToRef(c[3],c[4],c[5],l,this.pTemp),o.TransformCoordinatesFromFloatsToRef(this.pTemp.x,this.pTemp.y,this.pTemp.z,v,this.pTemp),n[p]=this.pTemp.x,n[p+1]=this.pTemp.y,n[p+2]=this.pTemp.z},t.prototype.highLightPoint=function(t,e,i){this.getFaceVertices(t,this.mesh,this.faceVertices);var o,s,r,n=e.subtract(this.v1v).length(),a=e.subtract(this.v2v).length(),h=e.subtract(this.v3v).length(),p=Math.min(n,a,h);p==n&&(this.p=1,o=this.v1v,s=this.v3v,r=this.v2v),p==a&&(this.p=2,o=this.v2v,s=this.v1v,r=this.v3v),p==h&&(this.p=3,o=this.v3v,s=this.v2v,r=this.v1v);var c=s.subtract(o),l=r.subtract(o);i.rotation=this.getRotation(c,l),i.position=o,this.ec.switchTo(i,!0)},t.prototype.updatePointPosition=function(t,e){var i=3*t,s=this.faceVertices[i+this.p-1],r=this.vertices,n=3*s,a=this.mesh.getWorldMatrix().clone().invert();o.TransformCoordinatesToRef(e.position,a,this.pTemp),r[n]=this.pTemp.x,r[n+1]=this.pTemp.y,r[n+2]=this.pTemp.z},t.prototype.getFaceVertices=function(t,e,i){var s=3*t,r=i[s],n=i[s+1],a=i[s+2],h=e.getWorldMatrix(),p=this.vertices,c=3*r,l=3*n,v=3*a;o.TransformCoordinatesFromFloatsToRef(p[c],p[c+1],p[c+2],h,this.v1v),o.TransformCoordinatesFromFloatsToRef(p[l],p[l+1],p[l+2],h,this.v2v),o.TransformCoordinatesFromFloatsToRef(p[v],p[v+1],p[v+2],h,this.v3v)},t.prototype.setMaterial=function(t,e,i){t.material=new r("",i),t.material.diffuseColor=e},t.prototype.clearColors=function(t){for(var e=t.length-3,i=0;i<e;i+=4)t[i]=1,t[i+1]=1,t[i+2]=1,t[i+3]=1},t.prototype.setColor=function(t,e,i){e[t]=i.r,e[t+1]=i.g,e[t+2]=i.b,e[t+3]=0},t.prototype.enableTranslation=function(){null!=this.ec&&this.ec.enableTranslation()},t.prototype.enableRotation=function(){null!=this.ec&&this.ec.enableRotation()},t.prototype.enableScaling=function(){null!=this.ec&&(this.ec.enableScaling(),this.ec.isLocal()||this.ec.setLocal(!0))},t.prototype.setSpaceLocal=function(){this.ec.setLocal(!0)},t.prototype.setSpaceWorld=function(){this.ec.setLocal(!1)},t.prototype.isLocal=function(){return this.ec.isLocal()},t.prototype.focus=function(){null!=this.ec&&(this.camera.target=this.ec.getPosition())},t.prototype.createTriangle=function(t,e,i){var o=new n(e/2,-e/2).addLineTo(e/2,e/2).addLineTo(-e/2,e/2).addLineTo(e/2,-e/2);return new BABYLON.PolygonMeshBuilder(t,o,i).build(!0)},t.prototype.getRotation=function(t,e){o.CrossToRef(t,e,this.pTemp);var i=o.Cross(this.pTemp,t);return o.RotationFromAxis(i,this.pTemp,t)},t.prototype.getDistance=function(t,e,i){var s=t.subtract(e),r=i.subtract(e),n=Math.acos(o.Dot(s,r.normalize())/s.length());return s.length()*Math.sin(n)},t}();e.MeshEditor=p}(e.component||(e.component={}))}(e.babylonjs||(e.babylonjs={}))}(t.ssatguru||(t.ssatguru={}))}(org||(org={}));